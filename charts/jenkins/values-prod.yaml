environment: production

jenkins:
  controller:
    installPlugins:
      - kubernetes:latest
      - workflow-aggregator:latest
      - git:latest
      - configuration-as-code:latest
      - credentials-binding:latest
      - github:latest
      - docker-plugin:latest
      - docker-workflow:latest
      - job-dsl:latest
      - blueocean:latest
      - pipeline-stage-view:latest

    resources:
      limits:
        cpu: "2000m"
        memory: "4Gi"
      requests:
        cpu: "1000m"
        memory: "2Gi"

    persistentVolume:
      size: 50Gi

    # Enable backup for production
    backup:
      enabled: true
      schedule: "H 2 * * *"

    JCasC:
      configScripts:
        security: |
          jenkins:
            securityRealm:
              local:
                allowsSignup: false
            authorizationStrategy:
              loggedInUsersCanDoAnything:
                allowAnonymousRead: false

        credentials: |
          credentials:
            system:
              domainCredentials:
                - credentials:
                    - string:
                        id: aws-account-id
                        scope: GLOBAL
                        secret: ${AWS_ACCOUNT_ID}
                        description: "AWS Account ID for ECR"
                    - usernamePassword:
                        id: github-token
                        scope: GLOBAL
                        username: ${GITHUB_USERNAME}
                        password: ${GITHUB_TOKEN}
                        description: "GitHub credentials for repo access"

        seed-job: |
          jobs:
            - script: >
                folder('production') {
                  displayName('Production Jobs')
                  description('Jobs for production environment - handle with care')
                }

                pipelineJob('production/django-app-deploy') {
                  description('Deploy Django application to production')
                  definition {
                    cpsScm {
                      scm {
                        git {
                          remote {
                            url("https://github.com/vladyslav-panchenko280/django-jenkins-app.git")
                            credentials("github-token")
                          }
                          branches("*/main")
                        }
                      }
                      scriptPath("./Jenkinsfile")
                    }
                  }
                }
